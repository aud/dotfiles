#!/usr/bin/env ruby

require 'open3'

# 1. Download homebrew
# 2. Running brew bundle (partly for many only - casks)
# 3. Symlink stuff
# 4. Source .bashrc
# 5. Source .system (for mac only)
# 6. Do some stuff to change default shell to bash?

module Utils
  # Common installation utilities

  class << self
    # Check if command exists
    def cmd_exists?(cmd)
      run_cmd("which #{cmd} >/dev/null 2>&1")
    end

    # Shell command out to system and output stdout, stderr
    def run_cmd(cmd)
      Open3.popen3(cmd) do |_stdin, stdout, stderr, wait_thr|
        out, err = ""

        while line = stdout.gets
          out = line
          puts line
        end
        while line = stderr.gets
          err = line
          puts line
        end

        return out, err, wait_thr.value
      end
    end
  end
end

def task(name)
  puts "[start] #{name}"
  yield
  puts "[finish] #{name}"
end

def darwin?
  Utils.run_cmd("uname").strip! == "Darwin"
end

def linux?
  Utils.run_cmd("uname").strip! == "Linux"
end

def install_brew
  task("brew") do
    unless Utils.cmd_exists?("brew")
      Utils.run_cmd('/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"')

      # Add to path if Linux
      if linux?
        puts "Do path stuff?"
      end

      Utils.run_cmd("brew bundle")
    end
  end
end


install_brew

# set -euox pipefail

# cd $HOME
# git clone https://github.com/aud/dotfiles
# cd dotfiles

# if ! command -v brew >/dev/null 2>&1; then
#   /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
# fi

# if test -f 'Brewfile' && command -v brew bundle check >/dev/null 2>&1; then
#   brew bundle
# fi

# . './symlink.sh'
# . './.bashrc'
